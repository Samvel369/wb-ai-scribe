import { NextResponse } from "next/server";
import OpenAI from "openai";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import { cookies } from "next/headers";

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
// –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENAI_BASE_URL –¥–ª—è –ø–µ—Ä–µ—á–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ (OpenAI, VseGPT, ProxyAPI)
const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY || "dummy",
    baseURL: process.env.OPENAI_BASE_URL || "https://api.openai.com/v1",
});

export async function POST(req: Request) {
    try {
        const { name, features, marketplace, tone } = await req.json();

        const cookieStore = cookies();
        const supabase = createRouteHandlerClient({ cookies: () => cookieStore });


        const { data: { session }, error: sessionError } = await supabase.auth.getSession();

        if (sessionError || !session) {
            // –ï—Å–ª–∏ –Ω–µ—Ç —Å–µ—Å—Å–∏–∏ –∏ –Ω–µ –¥–µ–º–æ —Ä–µ–∂–∏–º (–ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –Ω–∞–ª–∏—á–∏—é —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–ª—é—á–∞)
            if (!process.env.OPENAI_API_KEY) {
                // –ï—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç, —Ç–æ —ç—Ç–æ –¥–µ–º–æ —Ä–µ–∂–∏–º –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏)
                // –ù–æ —É –Ω–∞—Å –ª–æ–≥–∏–∫–∞ –∑–∞–≤—è–∑–∞–Ω–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö.
                // –ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –ø—É—Å–∫–∞—Ç—å –≥–æ—Å—Ç–µ–π - —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è.
                // –ü–æ–∫–∞ —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –±–µ–∑ –∫–ª—é—á–∞ –∏ –±–µ–∑ —Å–µ—Å—Å–∏–∏ - –Ω–µ–ª—å–∑—è.
                return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
            } else {
                return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
            }
        }

        const userId = session?.user?.id;

        // 1. –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å userId)
        let profile = null;
        if (userId) {
            const { data: userProfile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', userId)
                .single();
            profile = userProfile;

            // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç (—Å—Ç–∞—Ä—ã–π —é–∑–µ—Ä), —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
            if (!profile) {
                const { data: newProfile, error: createError } = await supabase
                    .from('profiles')
                    .insert({ id: userId })
                    .select()
                    .single();

                if (!createError) {
                    profile = newProfile;
                }
            }
        }

        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã (–ü–ï–†–ï–î –õ–Æ–ë–û–ô –ì–ï–ù–ï–†–ê–¶–ò–ï–ô)
        // –õ–æ–≥–∏–∫–∞ –ø–æ–¥–¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞
        const FREE_LIMIT = 3;

        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Premium, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ª–∏–º–∏—Ç–æ–≤
        const isPremium = profile?.is_premium === true;

        if (userId && profile && !isPremium) {
            const now = new Date();
            const lastReset = profile.last_reset_at ? new Date(profile.last_reset_at) : new Date(0);

            // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            console.log("Checking limits for user:", userId);
            console.log("Current time (UTC):", now.toISOString());
            console.log("Last reset (UTC):", lastReset.toISOString());
            console.log("Current Count:", profile.generation_count);

            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É (YYYY-MM-DD) –≤ UTC
            const isSameDay = now.toISOString().split('T')[0] === lastReset.toISOString().split('T')[0];
            console.log("Is same day (UTC):", isSameDay);

            if (!isSameDay) {
                console.log("Resetting daily limit...");
                const { error: resetError } = await supabase
                    .from('profiles')
                    .update({ generation_count: 0, last_reset_at: now.toISOString() })
                    .eq('id', userId);

                if (!resetError) {
                    profile.generation_count = 0;
                    console.log("Limit reset successful");
                } else {
                    console.error("Error resetting limit:", resetError);
                }
            } else {
                console.log("Limit update not required");
            }

            if (profile.generation_count >= FREE_LIMIT) {
                console.log("Limit reached!");
                return NextResponse.json(
                    { error: "Limit reached", limitReached: true },
                    { status: 403 }
                );
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏: –ï—Å–ª–∏ –∫–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É (–¥–µ–º–æ —Ä–µ–∂–∏–º "–±–µ–∑ –∫–ª—é—á–∞" —É–±–∏—Ä–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ —é–∑–µ—Ä —Ö–æ—á–µ—Ç —Ä–∞–±–æ—á–∏–π —Å–µ—Ä–≤–∏—Å)
        // –ò–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–µ–º–æ-–∑–∞–≥–ª—É—à–∫—É –µ—Å–ª–∏ –∫–ª—é—á–∞ —Ä–µ–∞–ª—å–Ω–æ –Ω–µ—Ç?
        // –Æ–∑–µ—Ä –ø—Ä–æ—Å–∏–ª –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∫–ª—é—á. –ò—Å–ø–æ–ª—å–∑—É–µ–º OPENAI_API_KEY.
        if (!process.env.OPENAI_API_KEY) {
            return NextResponse.json(
                { error: "Server misconfigured: OPENAI_API_KEY missing" },
                { status: 500 }
            );
        }


        let platform = 'Wildberries';
        switch (marketplace) {
            case 'ozon': platform = 'Ozon'; break;
            case 'avito': platform = 'Avito'; break;
            case 'instagram': platform = 'Instagram'; break;
            case 'telegram': platform = 'Telegram'; break;
            default: platform = 'Wildberries';
        }

        // –ü—Ä–æ–º–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è VseGPT/OpenAI
        // –ü—Ä–æ–º–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è VseGPT/OpenAI
        let systemPrompt = "";

        if (marketplace === 'avito') {
            systemPrompt = `–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–¥–∞–≤–µ—Ü –Ω–∞ Avito. 
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–∏—Å–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã–∑—ã–≤–∞–µ—Ç –¥–æ–≤–µ—Ä–∏–µ –∏ –∂–µ–ª–∞–Ω–∏–µ –ø–æ–∑–≤–æ–Ω–∏—Ç—å –∏–ª–∏ –Ω–∞–ø–∏—Å–∞—Ç—å.
            –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∏–ª—å: ${tone}.
            
            –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Avito:
            - –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∂–∏–≤—ã–º, –∫–∞–∫ –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –∏–ª–∏ —á–µ—Å—Ç–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏.
            - –ú–µ–Ω—å—à–µ "–≤–æ–¥—ã", –±–æ–ª—å—à–µ —Ñ–∞–∫—Ç–æ–≤.
            - –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
                1. –Ø—Ä–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–µ –≤—Å—Ç–∞–≤–ª—è–π –µ–≥–æ –≤ –Ω–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞, –ø—Ä–æ—Å—Ç–æ –¥–µ—Ä–∂–∏ –≤ –≥–æ–ª–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç).
                2. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ —Å—É—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (—á—Ç–æ –ø—Ä–æ–¥–∞–µ–º).
                3. –ü–æ—á–µ–º—É —Å—Ç–æ–∏—Ç –∫—É–ø–∏—Ç—å –∏–º–µ–Ω–Ω–æ —ç—Ç–æ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø–ª—é—Å—ã, –≤—ã–≥–æ–¥–∞).
                4. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (—Å–ø–∏—Å–∫–æ–º).
                5. –û–ø–ª–∞—Ç–∞ –∏ –¥–æ—Å—Ç–∞–≤–∫–∞ (–Ω–∞–ø–∏—à–∏, —á—Ç–æ –≤–æ–∑–º–æ–∂–Ω–∞ –ê–≤–∏—Ç–æ –î–æ—Å—Ç–∞–≤–∫–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç –¥–æ–≤–µ—Ä–∏–µ).
                6. –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é (–ó–≤–æ–Ω–∏—Ç–µ/–ü–∏—à–∏—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å).
            
            –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–µ SEO-—Ñ—Ä–∞–∑—ã, –ø–∏—à–∏ –¥–ª—è –ª—é–¥–µ–π.`;
        } else if (marketplace === 'instagram') {
            systemPrompt = `–¢—ã - SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –¥–ª—è Instagram.
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–∏—Å–∞—Ç—å –≤–æ–≤–ª–µ–∫–∞—é—â–∏–π –ø–æ—Å—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ —Ç–æ–≤–∞—Ä–∞.
            –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∏–ª—å: ${tone}.
            
            –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Instagram:
            - –í–∏–∑—É–∞–ª—å–Ω—ã–π —è–∑—ã–∫, –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —ç–º–æ–¥–∑–∏ üì∏‚ú®.
            - –¢–µ–∫—Å—Ç —Ä–∞–∑–±–∏—Ç –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã (–≤–æ–∑–¥—É—Ö).
            - –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
                1. –•—É–∫ (–∑–∞–≥–æ–ª–æ–≤–æ–∫), –∫–æ—Ç–æ—Ä—ã–π —Ü–µ–ø–ª—è–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ —Å –ø–µ—Ä–≤—ã—Ö —Å–ª–æ–≤.
                2. –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã/–±–æ–ª–∏ –∏ —Ä–µ—à–µ–Ω–∏–µ (–Ω–∞—à —Ç–æ–≤–∞—Ä).
                3. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞.
                4. –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é (–ù–∞–ø–∏—à–∏—Ç–µ –≤ Direct / –°—Å—ã–ª–∫–∞ –≤ —à–∞–ø–∫–µ –ø—Ä–æ—Ñ–∏–ª—è).
                5. –û–±–ª–∞–∫–æ —Ö—ç—à—Ç–µ–≥–æ–≤ (5-10 —à—Ç—É–∫) –≤ —Å–∞–º–æ–º –Ω–∏–∑—É.`;
        } else if (marketplace === 'telegram') {
            systemPrompt = `–¢—ã - –∞–≤—Ç–æ—Ä Telegram-–∫–∞–Ω–∞–ª–∞ –æ —Ç–æ–≤–∞—Ä–∞—Ö.
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π, –µ–º–∫–∏–π –∏ –ø—Ä–æ–±–∏–≤–Ω–æ–π –ø–æ—Å—Ç.
            –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∏–ª—å: ${tone}.
            
            –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Telegram:
            - –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç** –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤.
            - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞, –º–∏–Ω–∏–º—É–º –≤–æ–¥—ã.
            - –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
                1. **–ó–∞–≥–æ–ª–æ–≤–æ–∫** (–≤—ã–¥–µ–ª–∏ –∂–∏—Ä–Ω—ã–º).
                2. –°—É—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–±—É–ª–ª–∏—Ç—ã —Å –≥–∞–ª–æ—á–∫–∞–º–∏ ‚úÖ).
                3. –¶–µ–Ω–∞/–í—ã–≥–æ–¥–∞ (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ).
                4. –ö–Ω–æ–ø–∫–∞/–ü—Ä–∏–∑—ã–≤ (–ó–∞–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ç—É—Ç üëá).`;
        } else if (marketplace === 'max') {
            systemPrompt = `–¢—ã - –∞–≤—Ç–æ—Ä –∫–∞–Ω–∞–ª–∞ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ MAX.
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π, –µ–º–∫–∏–π –∏ –ø—Ä–æ–±–∏–≤–Ω–æ–π –ø–æ—Å—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ —Ç–æ–≤–∞—Ä–∞.
            –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∏–ª—å: ${tone}.

            –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ MAX:
            - –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º –∏ –≤–∏–∑—É–∞–ª—å–Ω–æ –ø—Ä–∏—è—Ç–Ω—ã–º.
            - –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è.
            - –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
                1. **–Ø—Ä–∫–∏–π –ó–∞–≥–æ–ª–æ–≤–æ–∫**.
                2. –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—É—Ç–∏ (—á—Ç–æ —ç—Ç–æ –∏ –∑–∞—á–µ–º –Ω—É–∂–Ω–æ).
                3. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ (–±—É–ª–ª–∏—Ç—ã).
                4. –¶–µ–Ω–∞ –∏ –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é.`;
        } else if (marketplace === 'yandex') {
            systemPrompt = `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–ú–∞—Ä–∫–µ—Ç–∞.
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞.
            –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∏–ª—å: ${tone}.

            –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –Ø–Ω–¥–µ–∫—Å.–ú–∞—Ä–∫–µ—Ç–∞:
            - –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–µ–∑–Ω—ã–º –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è.
            - –ò—Å–ø–æ–ª—å–∑—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –æ—Ä–≥–∞–Ω–∏—á–Ω–æ, –±–µ–∑ –ø–µ—Ä–µ—Å–ø–∞–º–∞.
            - –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
                1. –ö—Ä–∞—Ç–∫–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ (—á—Ç–æ —ç—Ç–æ –∏ –¥–ª—è —á–µ–≥–æ).
                2. –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
                3. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª–æ–≥–∞–º–∏.
                4. –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è.
                5. –û—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ).`;
        } else {
            // Default for Wildberries & Ozon
            systemPrompt = `–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤ ${platform}. 
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞—é—â–µ–µ, SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
            –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∏–ª—å: ${tone}.
            
            –ü–∏—à–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, —Ä–∞–∑–¥–µ–ª—è–π —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã. 
            –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤, –Ω–æ –Ω–µ –ø–µ—Ä–µ—É—Å–µ—Ä–¥—Å—Ç–≤—É–π.
            
            –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (–Ω–µ –ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–æ–≤, –ø—Ä–æ—Å—Ç–æ —Å–ª–µ–¥—É–π –ª–æ–≥–∏–∫–µ):
            1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ (H1) - —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ —Å –∫–ª—é—á–∞–º–∏ (CAPS LOCK).
            2. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ (—Å–ø–∏—Å–æ–∫ —Å –±—É–ª–ª–∏—Ç–∞–º–∏ –∏–ª–∏ —ç–º–æ–¥–∑–∏).
            3. –û–ø–∏—Å–∞–Ω–∏–µ (AIDA - –≤–Ω–∏–º–∞–Ω–∏–µ, –∏–Ω—Ç–µ—Ä–µ—Å, –∂–µ–ª–∞–Ω–∏–µ, –¥–µ–π—Å—Ç–≤–∏–µ).
            4. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–≤–ø–ª–µ—Ç–µ–Ω—ã –≤ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Å–ø–∏—Å–∫–æ–º).
            5. –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é.
            6. –ë–ª–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (—Ç—ç–≥–∏) –≤ –∫–æ–Ω—Ü–µ.
            
            –ù–µ –ø–∏—à–∏ "–û–ø–∏—Å–∞–Ω–∏–µ:", "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:" –∏ —Ç.–¥. —è–≤–Ω–æ, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.`;
        }

        const userPrompt = `–¢–æ–≤–∞—Ä: ${name}.
    –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏/–ö–ª—é—á–∏: ${features}.`;

        const completion = await openai.chat.completions.create({
            messages: [
                { role: "system", content: systemPrompt },
                { role: "user", content: userPrompt },
            ],
            // –ú–æ–¥–µ–ª—å –±–µ—Ä–µ—Ç—Å—è –∏–∑ .env, –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è. VseGPT –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç openai/gpt-3.5-turbo
            model: process.env.AI_MODEL || "openai/gpt-3.5-turbo",
            temperature: 0.7,
        });

        const description = completion.choices[0].message.content || "";

        // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        if (userId) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
            await saveToHistory(name, features, marketplace, tone, description);

            // –ï—Å–ª–∏ –ù–ï –ø—Ä–µ–º–∏—É–º, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
            if (!isPremium) {
                const { error: rpcError } = await supabase.rpc('increment_generation_count', { user_id: userId });
                if (rpcError) {
                    console.error("Error incrementing count:", rpcError);
                    // –ú–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å, –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ª–∏ –≤—ã–¥–∞—á—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –µ—Å–ª–∏ —Å—á–µ—Ç—á–∏–∫ –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è. 
                    // –û–±—ã—á–Ω–æ –ª—É—á—à–µ –æ—Ç–¥–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω–æ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É.
                }
            }
        }

        return NextResponse.json({ description, isMock: false });

    } catch (error) {
        console.error("AI Error:", error);
        return NextResponse.json(
            { error: "Failed to generate description. Check API Key." },
            { status: 500 }
        );
    }
}

async function saveToHistory(
    name: string,
    features: string,
    marketplace: string,
    tone: string,
    description: string
) {
    try {
        const cookieStore = cookies();
        const supabase = createRouteHandlerClient({ cookies: () => cookieStore });

        const { data: { session } } = await supabase.auth.getSession();

        if (session) {
            await supabase.from('generations').insert({
                user_id: session.user.id,
                product_name: name,
                description: description,
                marketplace: marketplace,
                features: features,
                tone: tone
            });
        }
    } catch (e: any) {
        console.error("Failed to save history:", e);
    }
}

const generateMockDescription = (name: string, features: string, mp: string) => {
    let platform = 'Wildberries';
    switch (mp) {
        case 'ozon': platform = 'Ozon'; break;
        case 'avito': platform = 'Avito'; break;
        case 'instagram': platform = 'Instagram'; break;
        case 'telegram': platform = 'Telegram'; break;
        default: platform = 'Wildberries';
    }

    return `[–î–ï–ú–û –†–ï–ñ–ò–ú]
üî• ${name.toUpperCase()} ‚Äî –•–ò–¢ –ü–†–û–î–ê–ñ –ù–ê ${platform.toUpperCase()}! üî•

–ò—â–µ—Ç–µ –∏–¥–µ–∞–ª—å–Ω—ã–π ${name}? –í—ã –µ–≥–æ –Ω–∞—à–ª–∏! –ù–∞—à —Ç–æ–≤–∞—Ä —Å–æ—á–µ—Ç–∞–µ—Ç –≤ —Å–µ–±–µ —Å—Ç–∏–ª—å, –∫–∞—á–µ—Å—Ç–≤–æ –∏ —É–¥–æ–±—Å—Ç–≤–æ.

‚úÖ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê:
${features ? `- ${features.split(',').join('\n- ')}` : '- –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤\n- –î–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å\n- –°—Ç–∏–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω 2024 –≥–æ–¥–∞'}

üìù –û–ü–ò–°–ê–ù–ò–ï:
–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤–∞–º ${name} ‚Äî –Ω–µ–∑–∞–º–µ–Ω–∏–º—ã–π –≤—ã–±–æ—Ä –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ü–µ–Ω–∏—Ç –∫–æ–º—Ñ–æ—Ä—Ç. –≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥–æ–π–¥–µ—Ç –∫–∞–∫ –¥–ª—è –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, —Ç–∞–∫ –∏ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–æ–¥–∞—Ä–∫–∞. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, —á—Ç–æ–±—ã –≤—ã –æ—Å—Ç–∞–ª–∏—Å—å –¥–æ–≤–æ–ª—å–Ω—ã –ø–æ–∫—É–ø–∫–æ–π.

‚≠ê –ü–û–ß–ï–ú–£ –í–´–ë–ò–†–ê–Æ–¢ –ù–ê–°:
‚Ä¢ –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
‚Ä¢ –ì–∞—Ä–∞–Ω—Ç–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
‚Ä¢ –¢—ã—Å—è—á–∏ –¥–æ–≤–æ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

üöÄ –£—Å–ø–µ–π—Ç–µ –∑–∞–∫–∞–∑–∞—Ç—å ${name} –ø–æ –≤—ã–≥–æ–¥–Ω–æ–π —Ü–µ–Ω–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å! –î–æ–±–∞–≤–ª—è–π—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É, –ø–æ–∫–∞ —Ç–æ–≤–∞—Ä –µ—Å—Ç—å –≤ –Ω–∞–ª–∏—á–∏–∏.

–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: ${name}, ${features}, –∫—É–ø–∏—Ç—å –Ω–∞ ${platform}, –ø–æ–¥–∞—Ä–æ–∫, —Å–∫–∏–¥–∫–∏, –∞–∫—Ü–∏—è.`;
}
